---
title: "Results elastic net on DELCODE data"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message=FALSE)

library(knitr)
library(dplyr)
library(ConnectomeR)
library(ggplot2)
```


```{r data}

setwd("../..")

result_table <- read.csv("results/result_table_elnet.csv") %>% select(-X)
regions <- read.csv("references/subregion_func_network_Yeo_updated.csv", sep = ";")

setwd("data/delcode/results")
elnet_conn <- readRDS("elnet_conn.rds")
elnet_conn_abs <- readRDS("elnet_conn_abs.rds")
elnet_conn_squ <- readRDS("elnet_conn_squ.rds")
elnet_conn_quadratic <- readRDS("elnet_conn_quadratic.rds")
elnet_agg_zero <- readRDS("elnet_agg_zero.rds")
elnet_agg_max <- readRDS("elnet_agg_max.rds")
elnet_agg_mean <- readRDS("elnet_agg_mean.rds")
elnet_gm_only <- readRDS("elnet_gm_only.rds")
elnet_gm_conn <- readRDS("elnet_gm_conn.rds")
elnet_agg_zero_inter <- readRDS("elnet_agg_zero_inter.rds")
elnet_agg_max_inter <- readRDS("elnet_agg_max_inter.rds")
elnet_agg_mean_inter <- readRDS("elnet_agg_mean_inter.rds")
# elnet_conn_inter <- readRDS("elnet_conn_inter.rds")

result_list <- list(elnet_conn, elnet_conn_abs, elnet_conn_squ, elnet_conn_quadratic, 
                    elnet_agg_zero, elnet_agg_max, elnet_agg_mean,
                    elnet_gm_only, elnet_gm_conn,
                    elnet_agg_zero_inter, elnet_agg_max_inter, elnet_agg_mean_inter# ,
                    # elnet_conn_inter
                    )
names(result_list) <- c("elnet_conn", "elnet_conn_abs", "elnet_conn_squ" , "elnet_conn_quadratic",
                        "elnet_agg_zero", "elnet_agg_max", "elnet_agg_mean",
                        "elnet_gm_only", "elnet_gm_conn",
                        "elnet_agg_zero_inter", "elnet_agg_max_inter", "elnet_agg_mean_inter" #,
                        # "elnet_conn_inter" 
                        )



```

# Performance - Comparison

The table includes the accuracy on test data, best alpha for accuracy on test data, AUC on test data, best alpha for AUC on test data, accuracy on training data, number of parameters.

**Models:** 

* *conn* = model on connectivity matrix, *abs, squ, quadratic* means fitted on absolute values/squared values/with quadratic functions 

* *agg* = model on matrix aggregated by network regions (yeo7), *zero, max, mean* means percentage greater than zero/maximum/mean in region

* *gm* = model on graph metrics, *only* means only on graph metrics, *conn* means model on graph metrics and connectivity matrix

* *inter* means that all two-way interactions are included

```{r result_table}

result_table %>% kable()

```

# Detailed Evaluation & Visualisation

## Visualisation

Plotted coefficients for some models (models on connectivity data and on data aggregated by regions, without interactions or squared functions). Shows best beta coefficient, best beta coefficient with alpha = 0 (Ridge-model, all coefficients != zero) and beta sorted by Yeo7-netword (for models on connectivity data).

\newpage 





```{r plots, fig.height=4}

for(i in 1:length(result_list)){
  
 
  model <- result_list[[i]]
  eval <- result_table_elnet(model)
  
  ind_alpha <- which(eval$accuracy$value == max(eval$accuracy$value))[1]
  alpha <- eval$accuracy[which(eval$accuracy$value == max(eval$accuracy$value)), "alpha"][1]
  ind_lambda <- eval$accuracy[which(eval$accuracy$value == max(eval$accuracy$value)), "ind_lambda"][1]

  # plot best beta/best ridge beta/beta sorted by regions
  if(names(result_list)[i] %in% c("elnet_conn", "elnet_conn_abs", "elnet_conn_squ",
                                  "elnet_agg_zero", "elnet_agg_max", "elnet_agg_mean")){
    
    beta_best <- model$results_models[[ind_alpha]]$model$beta[, ind_lambda]
    
    print(plot_matrix_coeffs(beta_best) + labs(title = paste0(names(result_list)[i], ", alpha = ", alpha, " (best model)")))
    
    if(alpha != 0){
      ind_lambda_ridge <- eval$accuracy[1, "ind_lambda"]
      best_beta_ridge <- model$results_models[[1]]$model$beta[, ind_lambda_ridge]
      print(plot_matrix_coeffs(best_beta_ridge) + labs(title = paste0(names(result_list)[i], ", alpha = ", 0, " (best ridge model)")))
    }
    
    # plot sorted by regions
    if(names(result_list)[i] %in% c("elnet_conn", "elnet_conn_abs", "elnet_conn_squ")){
      
       print(plot_matrix_coeffs(beta_best, regions_dat = regions[, c(1, 4)]) + 
        labs(title = paste0(names(result_list)[i], ", alpha = ", alpha, " (best model), sorted by Yeo7 network")))
      
      if(alpha != 0){
        ind_lambda_ridge <- eval$accuracy[1, "ind_lambda"]
        best_beta_ridge <- model$results_models[[1]]$model$beta[, ind_lambda_ridge]
        print(plot_matrix_coeffs(best_beta_ridge, regions_dat = regions[, c(1, 4)]) + 
          labs(title = paste0(names(result_list)[i], ", alpha = ", 0, " (best ridge model), sorted by Yeo7 network")))
        }
      
      }
    
    
    }
  
}



```

For elnet_agg_max, all coffecients of the region-matrix are zero for alpha = 0.3 (best model), only the coefficients of age and sex are unequal to zero.

\newpage 




## Confusion Matrices

Confusion matrix for every model with best alpha (based on test accuracy).

```{r conf}

for(i in 1:length(result_list)){

  print(names(result_list)[i])


  model <- result_list[[i]]
  eval <- result_table_elnet(model)

  ind_alpha <- which(eval$accuracy$value == max(eval$accuracy$value))[1]
  alpha <- eval$accuracy[which(eval$accuracy$value == max(eval$accuracy$value)), "alpha"][1]
  ind_lambda <- eval$accuracy[which(eval$accuracy$value == max(eval$accuracy$value)), "ind_lambda"][1]


  conf <- get_confMatrix_elnet(model, ind_alpha = ind_alpha, ind_lambda = ind_lambda)
  print(conf)


}



```
